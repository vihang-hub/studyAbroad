/**
 * Tests for React components
 */

import { describe, it, expect, beforeEach, afterEach } from 'vitest';
import { render, screen } from '@testing-library/react';
import React from 'react';
import { ConfigLoader } from '@study-abroad/shared-config';
import { FeatureFlags } from '../src/evaluator';
import { FeatureGate } from '../src/components';
import { Feature } from '../src/types';

describe('FeatureGate', () => {
  const originalEnv = { ...process.env };

  beforeEach(() => {
    FeatureFlags.reset();
    ConfigLoader.reset();
    process.env = {};
  });

  afterEach(() => {
    process.env = originalEnv;
    FeatureFlags.reset();
    ConfigLoader.reset();
  });

  describe('when feature is enabled', () => {
    beforeEach(() => {
      process.env.ENVIRONMENT_MODE = 'production';
      process.env.DATABASE_URL = 'postgresql://localhost:5432/test';
      process.env.ENABLE_SUPABASE = 'true';
      process.env.SUPABASE_URL = 'https://test.supabase.co';
      process.env.SUPABASE_ANON_KEY = 'test_anon_key';
      process.env.ENABLE_PAYMENTS = 'true';
      process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY = 'pk_test_123';
      process.env.STRIPE_SECRET_KEY = 'sk_test_123';
      process.env.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY = 'pk_test_123';
      process.env.CLERK_SECRET_KEY = 'sk_test_123';
      process.env.GEMINI_API_KEY = 'test_key';
    });

    it('should render children when enabled=true', () => {
      // Act
      render(
        <FeatureGate feature={Feature.PAYMENTS}>
          <div>Payment Content</div>
        </FeatureGate>,
      );

      // Assert
      expect(screen.getByText('Payment Content')).toBeDefined();
    });

    it('should not render children when enabled=false', () => {
      // Act
      render(
        <FeatureGate feature={Feature.PAYMENTS} enabled={false}>
          <div>Payment Content</div>
        </FeatureGate>,
      );

      // Assert
      expect(screen.queryByText('Payment Content')).toBeNull();
    });

    it('should render fallback when enabled=false', () => {
      // Act
      render(
        <FeatureGate
          feature={Feature.PAYMENTS}
          enabled={false}
          fallback={<div>Fallback Content</div>}
        >
          <div>Payment Content</div>
        </FeatureGate>,
      );

      // Assert
      expect(screen.getByText('Fallback Content')).toBeDefined();
      expect(screen.queryByText('Payment Content')).toBeNull();
    });
  });

  describe('when feature is disabled', () => {
    beforeEach(() => {
      process.env.ENVIRONMENT_MODE = 'dev';
      process.env.DATABASE_URL = 'postgresql://localhost:5432/test';
      process.env.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY = 'pk_test_123';
      process.env.CLERK_SECRET_KEY = 'sk_test_123';
      process.env.GEMINI_API_KEY = 'test_key';
    });

    it('should not render children when enabled=true (default)', () => {
      // Act
      render(
        <FeatureGate feature={Feature.PAYMENTS}>
          <div>Payment Content</div>
        </FeatureGate>,
      );

      // Assert
      expect(screen.queryByText('Payment Content')).toBeNull();
    });

    it('should render children when enabled=false', () => {
      // Act
      render(
        <FeatureGate feature={Feature.PAYMENTS} enabled={false}>
          <div>Free Content</div>
        </FeatureGate>,
      );

      // Assert
      expect(screen.getByText('Free Content')).toBeDefined();
    });

    it('should render fallback when enabled=true and feature is disabled', () => {
      // Act
      render(
        <FeatureGate
          feature={Feature.PAYMENTS}
          enabled={true}
          fallback={<div>Payments Disabled</div>}
        >
          <div>Payment Content</div>
        </FeatureGate>,
      );

      // Assert
      expect(screen.getByText('Payments Disabled')).toBeDefined();
      expect(screen.queryByText('Payment Content')).toBeNull();
    });

    it('should render nothing when no fallback provided', () => {
      // Act
      const { container } = render(
        <FeatureGate feature={Feature.PAYMENTS}>
          <div>Payment Content</div>
        </FeatureGate>,
      );

      // Assert
      expect(container.textContent).toBe('');
    });
  });

  describe('with different features', () => {
    it('should work with SUPABASE feature', () => {
      // Arrange
      process.env.ENVIRONMENT_MODE = 'test';
      process.env.DATABASE_URL = 'postgresql://localhost:5432/test';
      process.env.ENABLE_SUPABASE = 'true';
      process.env.SUPABASE_URL = 'https://test.supabase.co';
      process.env.SUPABASE_ANON_KEY = 'test_anon_key';
      process.env.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY = 'pk_test_123';
      process.env.CLERK_SECRET_KEY = 'sk_test_123';
      process.env.GEMINI_API_KEY = 'test_key';

      // Act
      render(
        <FeatureGate feature={Feature.SUPABASE}>
          <div>Supabase Content</div>
        </FeatureGate>,
      );

      // Assert
      expect(screen.getByText('Supabase Content')).toBeDefined();
    });

    it('should work with RATE_LIMITING feature', () => {
      // Arrange
      process.env.ENVIRONMENT_MODE = 'production';
      process.env.DATABASE_URL = 'postgresql://localhost:5432/test';
      process.env.ENABLE_SUPABASE = 'true';
      process.env.SUPABASE_URL = 'https://test.supabase.co';
      process.env.SUPABASE_ANON_KEY = 'test_anon_key';
      process.env.ENABLE_PAYMENTS = 'true';
      process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY = 'pk_test_123';
      process.env.STRIPE_SECRET_KEY = 'sk_test_123';
      process.env.ENABLE_RATE_LIMITING = 'true';
      process.env.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY = 'pk_test_123';
      process.env.CLERK_SECRET_KEY = 'sk_test_123';
      process.env.GEMINI_API_KEY = 'test_key';

      // Act
      render(
        <FeatureGate feature={Feature.RATE_LIMITING}>
          <div>Rate Limiting Content</div>
        </FeatureGate>,
      );

      // Assert
      expect(screen.getByText('Rate Limiting Content')).toBeDefined();
    });

    it('should work with OBSERVABILITY feature', () => {
      // Arrange
      process.env.ENVIRONMENT_MODE = 'production';
      process.env.DATABASE_URL = 'postgresql://localhost:5432/test';
      process.env.ENABLE_SUPABASE = 'true';
      process.env.SUPABASE_URL = 'https://test.supabase.co';
      process.env.SUPABASE_ANON_KEY = 'test_anon_key';
      process.env.ENABLE_PAYMENTS = 'true';
      process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY = 'pk_test_123';
      process.env.STRIPE_SECRET_KEY = 'sk_test_123';
      process.env.ENABLE_OBSERVABILITY = 'true';
      process.env.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY = 'pk_test_123';
      process.env.CLERK_SECRET_KEY = 'sk_test_123';
      process.env.GEMINI_API_KEY = 'test_key';

      // Act
      render(
        <FeatureGate feature={Feature.OBSERVABILITY}>
          <div>Observability Content</div>
        </FeatureGate>,
      );

      // Assert
      expect(screen.getByText('Observability Content')).toBeDefined();
    });
  });

  describe('edge cases', () => {
    it('should handle complex children', () => {
      // Arrange
      process.env.ENVIRONMENT_MODE = 'production';
      process.env.DATABASE_URL = 'postgresql://localhost:5432/test';
      process.env.ENABLE_SUPABASE = 'true';
      process.env.SUPABASE_URL = 'https://test.supabase.co';
      process.env.SUPABASE_ANON_KEY = 'test_anon_key';
      process.env.ENABLE_PAYMENTS = 'true';
      process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY = 'pk_test_123';
      process.env.STRIPE_SECRET_KEY = 'sk_test_123';
      process.env.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY = 'pk_test_123';
      process.env.CLERK_SECRET_KEY = 'sk_test_123';
      process.env.GEMINI_API_KEY = 'test_key';

      // Act
      render(
        <FeatureGate feature={Feature.PAYMENTS}>
          <div>
            <h1>Heading</h1>
            <p>Paragraph</p>
            <button type="button">Button</button>
          </div>
        </FeatureGate>,
      );

      // Assert
      expect(screen.getByText('Heading')).toBeDefined();
      expect(screen.getByText('Paragraph')).toBeDefined();
      expect(screen.getByText('Button')).toBeDefined();
    });

    it('should handle nested FeatureGates', () => {
      // Arrange
      process.env.ENVIRONMENT_MODE = 'production';
      process.env.DATABASE_URL = 'postgresql://localhost:5432/test';
      process.env.ENABLE_SUPABASE = 'true';
      process.env.SUPABASE_URL = 'https://test.supabase.co';
      process.env.SUPABASE_ANON_KEY = 'test_anon_key';
      process.env.ENABLE_PAYMENTS = 'true';
      process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY = 'pk_test_123';
      process.env.STRIPE_SECRET_KEY = 'sk_test_123';
      process.env.ENABLE_RATE_LIMITING = 'true';
      process.env.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY = 'pk_test_123';
      process.env.CLERK_SECRET_KEY = 'sk_test_123';
      process.env.GEMINI_API_KEY = 'test_key';

      // Act
      render(
        <FeatureGate feature={Feature.PAYMENTS}>
          <div>
            Payments Enabled
            <FeatureGate feature={Feature.RATE_LIMITING}>
              <div>Rate Limiting Also Enabled</div>
            </FeatureGate>
          </div>
        </FeatureGate>,
      );

      // Assert
      expect(screen.getByText('Payments Enabled')).toBeDefined();
      expect(screen.getByText('Rate Limiting Also Enabled')).toBeDefined();
    });

    it('should handle empty children', () => {
      // Arrange
      process.env.ENVIRONMENT_MODE = 'dev';
      process.env.DATABASE_URL = 'postgresql://localhost:5432/test';
      process.env.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY = 'pk_test_123';
      process.env.CLERK_SECRET_KEY = 'sk_test_123';
      process.env.GEMINI_API_KEY = 'test_key';

      // Act
      const { container } = render(
        <FeatureGate feature={Feature.PAYMENTS}>
          {null}
        </FeatureGate>,
      );

      // Assert
      expect(container.textContent).toBe('');
    });

    it('should handle text children', () => {
      // Arrange
      process.env.ENVIRONMENT_MODE = 'production';
      process.env.DATABASE_URL = 'postgresql://localhost:5432/test';
      process.env.ENABLE_SUPABASE = 'true';
      process.env.SUPABASE_URL = 'https://test.supabase.co';
      process.env.SUPABASE_ANON_KEY = 'test_anon_key';
      process.env.ENABLE_PAYMENTS = 'true';
      process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY = 'pk_test_123';
      process.env.STRIPE_SECRET_KEY = 'sk_test_123';
      process.env.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY = 'pk_test_123';
      process.env.CLERK_SECRET_KEY = 'sk_test_123';
      process.env.GEMINI_API_KEY = 'test_key';

      // Act
      render(
        <FeatureGate feature={Feature.PAYMENTS}>
          Plain text content
        </FeatureGate>,
      );

      // Assert
      expect(screen.getByText('Plain text content')).toBeDefined();
    });
  });
});
